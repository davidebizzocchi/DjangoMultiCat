{% extends "base/base.html" %}
{% load static %}

{% block title %}Chat{% endblock %}

{% block reload %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" crossorigin="" href="{% static 'css/cat_chat.css' %}">
<link rel="stylesheet" crossorigin="" href="{% static 'css/chat.css' %}">
{% endblock %}

{% block contenuto %}


{% include 'chat/_streaming/proto_objects.html' %}

    <h1>Chat</h1>

    {% include 'chat/_streaming/chat_app.html' %}

    <script>
        $(document).ready(function() {
        // Select all elements with class 'markdown' //
        $('.markdown').each(function() {
            let target = $(this);
            target.html(convertToHTML(target.text()));
        });

        // Fix error 3 white spaces //
        $("#message-input").text('');
        $("#message-input").focus();


        // Last action: scrolling down
        let container = $("#app-container");
        container.animate({ scrollTop: container.find("#app").get(0).scrollHeight }, 200);
    });

    // Resize textarea
    $(document).on("input", "#message-input", function(e) {
        let textarea = $(e.currentTarget);
        textarea.css('height', "48px");
        textarea.css('height', textarea[0].scrollHeight + 'px');
    });
    
    // Send message with enter
    $(document).on("keydown", "#message-input", function(event) {
        if (event.key === 'Enter') {
            event.preventDefault(); // Impedisce il comportamento predefinito di andare a capo
            $('#chatForm').submit(); // Invia il modulo
        }
    });

    // Convert Markdown into HTML
    function convertToHTML(html_content) {
        return marked.parse(html_content);
    }

    // Wipe chat handler
    $(document).on("click", "#wipe-chat", async function(e) {
        e.preventDefault();
        
        // if (!confirm("Sei sicuro di voler cancellare la memoria della chat? Questa azione non pu√≤ essere annullata.")) {
        //     return;
        // }

        try {
            const response = await fetch('{% url "chat:wipe-chat-api" chat_id=chat_id %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name="csrfmiddlewaretoken"]').value,
                }
            });

            if (response.ok) {
                // Clear messages from UI
                $("#responses").empty();
            } else {
                alert("Errore durante la pulizia della chat");
            }
        } catch (error) {
            console.error('Error:', error);
            alert("Errore durante la pulizia della chat");
        }
    });
    
    {% include 'chat/_streaming/js_audio.js' %}

    // Dopo js_audio!
    {% include 'chat/_streaming/js_menu_handler.js' %}
</script>

<script type="module">
    {% include 'chat/_streaming/js_sse.js' %}
</script>

{% endblock %}